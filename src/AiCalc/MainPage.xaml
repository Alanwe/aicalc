<Page x:Name="PageRoot"
    x:Class="AiCalc.MainPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:AiCalc"
    xmlns:services="using:AiCalc.Services"
    xmlns:models="using:AiCalc.Models"
    xmlns:vm="using:AiCalc.ViewModels"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:conv="using:AiCalc.Converters"
    mc:Ignorable="d"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008">

    <Page.Resources>
        <conv:BooleanToBrushConverter x:Key="CellSelectionBrushConverter"
                                       TrueBrush="{StaticResource SpreadsheetAccentBrush}"
                                       FalseBrush="{StaticResource SpreadsheetCardBrush}" />
        <conv:AutomationModeToGlyphConverter x:Key="AutomationGlyphConverter" />
        <conv:BooleanNegationConverter x:Key="BooleanNegationConverter" />
        <conv:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <conv:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
        <Style x:Key="CellButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="VerticalContentAlignment" Value="Stretch" />
        </Style>
    </Page.Resources>

    <Grid Background="{StaticResource SpreadsheetBackgroundBrush}">
        <NavigationView x:Name="RootNavigation"
                        IsSettingsVisible="True"
                        PaneDisplayMode="Top"
                        AlwaysShowHeader="True"
                        IsPaneToggleButtonVisible="False"
                        IsTitleBarAutoPaddingEnabled="False">
            <NavigationView.MenuItems>
                <NavigationViewItem Icon="Home" Content="Dashboard" />
                <NavigationViewItem Icon="Library" Content="Functions" />
                <NavigationViewItem Icon="Settings" Content="Settings" />
            </NavigationView.MenuItems>

            <NavigationView.Header>
                <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                    <TextBlock Text="AiCalc Studio" FontSize="18" FontFamily="{StaticResource HeadingFont}" Foreground="White" />
                    <TextBox Width="240"
                             PlaceholderText="Workbook title"
                             Text="{x:Bind ViewModel.Title, Mode=TwoWay}"
                             FontFamily="{StaticResource BodyFont}" />
                    <Button Content="New Sheet"
                            Command="{x:Bind ViewModel.NewSheetCommand}"
                            Style="{StaticResource AccentButtonStyle}" />
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                        <Button Content="Evaluate Sheet"
                                Command="{x:Bind ViewModel.EvaluateSheetCommand}"
                                Style="{StaticResource AccentButtonStyle}" />
                        <Button Content="Evaluate All"
                                Command="{x:Bind ViewModel.EvaluateWorkbookCommand}"
                                Style="{StaticResource AccentButtonStyle}" />
                        <Button Content="Save"
                                Command="{x:Bind ViewModel.SaveCommand}"
                                Style="{StaticResource AccentButtonStyle}" />
                        <Button Content="Load"
                                Command="{x:Bind ViewModel.LoadCommand}"
                                Style="{StaticResource AccentButtonStyle}" />
                    </StackPanel>
                </StackPanel>
            </NavigationView.Header>

            <NavigationView.Content>
                <Grid Padding="24" ColumnSpacing="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="320" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="360" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Spacing="16">
                        <Border Background="{StaticResource SpreadsheetCardBrush}"
                                Padding="16"
                                CornerRadius="12">
                            <StackPanel Spacing="12">
                                <TextBlock Text="Function Explorer"
                                           Foreground="White"
                                           FontFamily="{StaticResource HeadingFont}"
                                           FontSize="18" />
                                <TextBox PlaceholderText="Search functions" />
                                <ListView ItemsSource="{x:Bind ViewModel.FunctionRegistry.Functions}"
                                          SelectionMode="Single"
                                          MinHeight="260">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="services:FunctionDescriptor">
                                            <StackPanel Spacing="4">
                                                <TextBlock Text="{x:Bind Name}" Foreground="White" FontWeight="SemiBold" />
                                                <TextBlock Text="{x:Bind Description}"
                                                           TextWrapping="Wrap"
                                                           Foreground="#AAFFFFFF"
                                                           FontSize="12" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                            </StackPanel>
                        </Border>

                        <Border Background="{StaticResource SpreadsheetCardBrush}"
                                Padding="16"
                                CornerRadius="12">
                            <StackPanel Spacing="12">
                                <TextBlock Text="Connections"
                                           Foreground="White"
                                           FontFamily="{StaticResource HeadingFont}" />
                                <ListView ItemsSource="{x:Bind ViewModel.Settings.Connections}" MinHeight="120">
                                    <ListView.ItemTemplate>
                                        <DataTemplate x:DataType="models:WorkspaceConnection">
                                            <StackPanel>
                                                <TextBlock Text="{x:Bind Name}" Foreground="White" />
                                                <TextBlock Text="{x:Bind Provider}" Foreground="#AAFFFFFF" FontSize="12" />
                                                <TextBlock Text="{x:Bind Endpoint}" Foreground="#66FFFFFF" FontSize="10" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListView.ItemTemplate>
                                </ListView>
                                <Button Content="Add Connection" Style="{StaticResource AccentButtonStyle}" />
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <Border Grid.Column="1"
                            Background="{StaticResource SpreadsheetCardBrush}"
                            Padding="12"
                            CornerRadius="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>
                            <muxc:TabView TabWidthMode="Equal"
                                          ItemsSource="{x:Bind ViewModel.Sheets}"
                                          SelectedItem="{x:Bind ViewModel.SelectedSheet, Mode=TwoWay}">
                                <muxc:TabView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:SheetViewModel">
                                        <TextBlock Text="{x:Bind Name}" />
                                    </DataTemplate>
                                </muxc:TabView.ItemTemplate>
                                <muxc:TabView.ContentTemplate>
                                    <DataTemplate x:DataType="vm:SheetViewModel">
                                        <Grid>
                                            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                          VerticalScrollBarVisibility="Auto">
                                                <StackPanel>
                                                    <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,0,0,12">
                                                        <Border Width="48" Background="#33000000" CornerRadius="8" Padding="8" />
                                                        <ItemsRepeater ItemsSource="{x:Bind ColumnHeaders}">
                                                            <ItemsRepeater.Layout>
                                                                <muxc:StackLayout Orientation="Horizontal" />
                                                            </ItemsRepeater.Layout>
                                                            <ItemsRepeater.ItemTemplate>
                                                                <DataTemplate x:DataType="x:String">
                                                                    <Border Width="120" Background="#33000000" CornerRadius="8" Padding="8">
                                                                        <TextBlock Text="{x:Bind}" Foreground="#CCFFFFFF" HorizontalAlignment="Center" />
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ItemsRepeater.ItemTemplate>
                                                        </ItemsRepeater>
                                                    </StackPanel>
                                                    <ItemsRepeater ItemsSource="{x:Bind Rows}">
                                                        <ItemsRepeater.Layout>
                                                            <muxc:StackLayout Orientation="Vertical" />
                                                        </ItemsRepeater.Layout>
                                                        <ItemsRepeater.ItemTemplate>
                                                            <DataTemplate x:DataType="vm:RowViewModel">
                                                                <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
                                                                    <Border Width="48"
                                                                            Background="#33000000"
                                                                            CornerRadius="8"
                                                                            Padding="8"
                                                                            VerticalAlignment="Stretch">
                                                                        <TextBlock Text="{x:Bind Label, Mode=OneWay}"
                                                                                   Foreground="#88FFFFFF"
                                                                                   HorizontalAlignment="Center" />
                                                                    </Border>
                                                                    <ItemsRepeater ItemsSource="{x:Bind Cells}">
                                                                        <ItemsRepeater.Layout>
                                                                            <muxc:StackLayout Orientation="Horizontal" />
                                                                        </ItemsRepeater.Layout>
                                                                        <ItemsRepeater.ItemTemplate>
                                                                            <DataTemplate x:DataType="vm:CellViewModel">
                                                                                <Button Command="{x:Bind Sheet.Workbook.SelectCellCommand}"
                                                                                        CommandParameter="{x:Bind}"
                                                                                        Style="{StaticResource CellButtonStyle}"
                                                                                        HorizontalAlignment="Stretch"
                                                                                        VerticalAlignment="Stretch">
                                                                                    <Border Width="120"
                                                                                            Height="72"
                                                                                            Padding="8"
                                                                                            Background="{Binding IsSelected, Converter={StaticResource CellSelectionBrushConverter}}"
                                                                                            CornerRadius="10"
                                                                                            BorderBrush="#11FFFFFF"
                                                                                            BorderThickness="1"
                                                                                            ToolTipService.ToolTip="{x:Bind DisplayLabel}">
                                                                                        <StackPanel>
                                                                                            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                                                                                <FontIcon Glyph="{x:Bind ObjectTypeGlyph}" Foreground="White" />
                                                                                                <FontIcon Glyph="{Binding AutomationMode, Converter={StaticResource AutomationGlyphConverter}}" Foreground="#AAFFFFFF" />
                                                                                                <TextBlock Text="{x:Bind DisplayLabel}"
                                                                                                           Foreground="#AAFFFFFF"
                                                                                                           FontSize="12" />
                                                                                            </StackPanel>
                                                                                            <TextBlock Text="{x:Bind DisplayValue}"
                                                                                                       TextWrapping="Wrap"
                                                                                                       Foreground="White"
                                                                                                       FontSize="14"
                                                                                                       Margin="0,6,0,0" />
                                                                                        </StackPanel>
                                                                                    </Border>
                                                                                </Button>
                                                                            </DataTemplate>
                                                                        </ItemsRepeater.ItemTemplate>
                                                                    </ItemsRepeater>
                                                                </StackPanel>
                                                            </DataTemplate>
                                                        </ItemsRepeater.ItemTemplate>
                                                    </ItemsRepeater>
                                                </StackPanel>
                                            </ScrollViewer>
                                        </Grid>
                                    </DataTemplate>
                                </muxc:TabView.ContentTemplate>
                            </muxc:TabView>
                        </Grid>
                    </Border>

                    <Border Grid.Column="2"
                            Background="{StaticResource SpreadsheetCardBrush}"
                            Padding="20"
                            CornerRadius="12">
                        <StackPanel Spacing="16">
                            <TextBlock Text="Cell Inspector"
                                       Foreground="White"
                                       FontFamily="{StaticResource HeadingFont}"
                                       FontSize="18" />
                            <StackPanel Visibility="{Binding Source={x:Reference Name=PageRoot}, Path=DataContext.HasActiveCell, Converter={StaticResource BooleanToVisibilityConverter}}" Spacing="12"
                                DataContext="{Binding Source={x:Reference Name=PageRoot}, Path=DataContext.ActiveCell}">
                                <TextBlock Text="{Binding DisplayLabel}" Foreground="White" FontSize="16" />
                                <TextBlock Text="Value" Foreground="#AAFFFFFF" />
                                <TextBox Text="{Binding RawValue, Mode=TwoWay}" AcceptsReturn="True" Height="60" />
                                <TextBlock Text="Formula" Foreground="#AAFFFFFF" />
                                <TextBox Text="{Binding Formula, Mode=TwoWay}" PlaceholderText="=SUM(Sheet1!A1,Sheet1!A2)" />
                                <TextBlock Text="Automation" Foreground="#AAFFFFFF" />
                                <ComboBox ItemsSource="{Binding Source={x:Reference Name=PageRoot}, Path=DataContext.AutomationModes}"
                                          SelectedItem="{Binding AutomationMode, Mode=TwoWay}" />
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <Button Content="Run"
                                            Command="{Binding RunCommand}"
                                            Style="{StaticResource AccentButtonStyle}" />
                                    <Button Content="Clear"
                                            Command="{Binding Source={x:Reference Name=PageRoot}, Path=DataContext.ClearSelectionCommand}"
                                            Style="{StaticResource AccentButtonStyle}" />
                                </StackPanel>
                                <TextBlock Text="Notes" Foreground="#AAFFFFFF" />
                                <TextBox Text="{Binding Notes, Mode=TwoWay}" AcceptsReturn="True" Height="60" />
                            </StackPanel>
                            <TextBlock Text="Select a cell to edit." Foreground="#55FFFFFF" Visibility="{Binding Source={x:Reference Name=PageRoot}, Path=DataContext.HasActiveCell, Converter={StaticResource InverseBooleanToVisibilityConverter}}" />
                        </StackPanel>
                    </Border>
                </Grid>
            </NavigationView.Content>
        </NavigationView>

        <Grid VerticalAlignment="Bottom" Background="#22000000" Height="36" Padding="16,0">
            <StackPanel Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                <ProgressRing Width="20" Height="20" IsActive="{x:Bind ViewModel.IsBusy}" Foreground="{StaticResource SpreadsheetAccentBrush}" />
                <TextBlock Text="{x:Bind ViewModel.StatusMessage}" Foreground="#AAFFFFFF" />
            </StackPanel>
        </Grid>
    </Grid>
</Page>
